/* Pico‑Optimized Dual‑Axis Mini Chart.js (Volt left, Ampere right) */
(function (global) {

    function Chart(ctx, config) {

        const canvas = ctx.canvas;
        const c = ctx;

        const datasets = config.data.datasets;   // [0] = Voltage, [1] = Current
        const labels = config.data.labels;

        function draw() {

            const w = canvas.width;
            const h = canvas.height;

            c.clearRect(0, 0, w, h);

            if (labels.length === 0) return;

            // ---------------------------
            // VOLTAGE SCALE (LEFT AXIS)
            // ---------------------------
            const voltData = datasets[0].data;
            const vMin = Math.min(...voltData, 0);
            const vMax = Math.max(...voltData, 1);
            const vRange = vMax - vMin || 1;

            // ---------------------------
            // CURRENT SCALE (RIGHT AXIS)
            // ---------------------------
            const ampData = datasets[1].data;
            const aMin = Math.min(...ampData, 0);
            const aMax = Math.max(...ampData, 1);
            const aRange = aMax - aMin || 1;

            // ---------------------------
            // DRAW GRIDLINES & LABELS LEFT (V)
            // ---------------------------
            c.font = "10px sans-serif";

            for (let i = 0; i <= 10; i++) {

                const y = h - (i * (h / 10));

                // Gridline
                c.strokeStyle = "#444";
                c.lineWidth = 1;
                c.beginPath();
                c.moveTo(25, y);
                c.lineTo(w - 25, y);
                c.stroke();

                // Left axis label (V)
                const vVal = vMin + i * (vRange / 10);
                const vText = Math.round(vVal * 10) / 10;
                c.fillStyle = "#4CAF50";
                c.fillText(vText, 2, y - 2);
            }

            // ---------------------------
            // DRAW RIGHT AXIS LABELS (A)
            // ---------------------------
            for (let i = 0; i <= 10; i++) {

                const y = h - (i * (h / 10));
                const aVal = aMin + i * (aRange / 10);
                const aText = Math.round(aVal * 1000) / 1000;

                c.fillStyle = "#f44336";
                c.fillText(aText, w - 30, y - 2);
            }

            // ---------------------------
            // DRAW DATASETS
            // ---------------------------
            function yVolt(v) {
                return h - ((v - vMin) / vRange) * (h - 10) - 5;
            }

            function yAmp(a) {
                return h - ((a - aMin) / aRange) * (h - 10) - 5;
            }

            // Voltage (left axis)
            c.beginPath();
            c.strokeStyle = datasets[0].borderColor || "#4CAF50";
            c.lineWidth = datasets[0].borderWidth || 2;

            datasets[0].data.forEach((v, i) => {
                const x = 25 + (i / Math.max(1, labels.length - 1)) * (w - 50);
                const y = yVolt(v);
                if (i === 0) c.moveTo(x, y);
                else c.lineTo(x, y);
            });
            c.stroke();

            // Current (right axis)
            c.beginPath();
            c.strokeStyle = datasets[1].borderColor || "#f44336";
            c.lineWidth = datasets[1].borderWidth || 2;

            datasets[1].data.forEach((a, i) => {
                const x = 25 + (i / Math.max(1, labels.length - 1)) * (w - 50);
                const y = yAmp(a);
                if (i === 0) c.moveTo(x, y);
                else c.lineTo(x, y);
            });
            c.stroke();
        }

        this.data = config.data;
        this.update = draw;

        draw();
    }

    global.Chart = Chart;

})(this);
