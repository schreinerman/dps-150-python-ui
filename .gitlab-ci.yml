stages:
  - build
  - release

variables:
  PYTHON_VERSION: "3.11"
  APP_NAME: "DPS150-Control"

# macOS Build
build:macos:
  stage: build
  tags:
    - macos
  before_script:
    - python3 --version
    - python3 -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements-build.txt
  script:
    - python build.py
  artifacts:
    name: "${APP_NAME}-macos-${CI_COMMIT_SHORT_SHA}"
    paths:
      - dist/${APP_NAME}.app
      - dist/${APP_NAME}
    expire_in: 30 days
  only:
    - main
    - tags
    - merge_requests

# Linux Build
build:linux:
  stage: build
  image: python:3.11-slim
  tags:
    - linux
  before_script:
    - apt-get update && apt-get install -y 
        libgl1-mesa-glx 
        libglib2.0-0 
        libxcb-icccm4 
        libxcb-image0 
        libxcb-keysyms1 
        libxcb-randr0 
        libxcb-render-util0 
        libxcb-xinerama0 
        libxcb-xfixes0 
        libxkbcommon-x11-0 
        libdbus-1-3
    - python --version
    - pip install --upgrade pip
    - pip install -r requirements-build.txt
  script:
    - python build.py
  artifacts:
    name: "${APP_NAME}-linux-${CI_COMMIT_SHORT_SHA}"
    paths:
      - dist/${APP_NAME}
    expire_in: 30 days
  only:
    - main
    - tags
    - merge_requests

# Windows Build
build:windows:
  stage: build
  tags:
    - windows
  before_script:
    - python --version
    - python -m venv venv
    - .\venv\Scripts\Activate.ps1
    - pip install --upgrade pip
    - pip install -r requirements-build.txt
  script:
    - python build.py
  artifacts:
    name: "${APP_NAME}-windows-${CI_COMMIT_SHORT_SHA}"
    paths:
      - dist/${APP_NAME}.exe
    expire_in: 30 days
  only:
    - main
    - tags
    - merge_requests

# Optional: Package Release for Git Tags
release:package:
  stage: release
  image: alpine:latest
  dependencies:
    - build:macos
    - build:linux
    - build:windows
  before_script:
    - apk add --no-cache zip tar
  script:
    - mkdir -p releases
    - cd dist
    # macOS
    - tar -czf ../releases/${APP_NAME}-macos-${CI_COMMIT_TAG}.tar.gz ${APP_NAME}.app ${APP_NAME} || true
    # Linux
    - tar -czf ../releases/${APP_NAME}-linux-${CI_COMMIT_TAG}.tar.gz ${APP_NAME} || true
    # Windows
    - zip -r ../releases/${APP_NAME}-windows-${CI_COMMIT_TAG}.zip ${APP_NAME}.exe || true
  artifacts:
    name: "${APP_NAME}-${CI_COMMIT_TAG}"
    paths:
      - releases/
    expire_in: never
  only:
    - tags
