<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>FNIRSI DPS-150 - Python Edition</title>
    
    <!-- Local libraries (fallback to CDN if not available) -->
    <link href="{{ url_for('static', filename='libs/materialdesignicons.min.css') }}" rel="stylesheet" onerror="this.onerror=null; this.href='https://cdn.jsdelivr.net/npm/@mdi/font@7.x/css/materialdesignicons.min.css'">
    <link href="{{ url_for('static', filename='libs/vuetify.min.css') }}" rel="stylesheet" onerror="this.onerror=null; this.href='https://cdn.jsdelivr.net/npm/vuetify@3.7.4/dist/vuetify.min.css'">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Monomaniac+One&family=Noto+Sans+JP:wght@100..900&display=swap" rel="stylesheet">
    
    <script src="{{ url_for('static', filename='libs/vue.global.min.js') }}" onerror="this.onerror=null; this.src='https://cdn.jsdelivr.net/npm/vue@3.5.13/dist/vue.global.min.js'"></script>
    <script src="{{ url_for('static', filename='libs/vuetify.min.js') }}" onerror="this.onerror=null; this.src='https://cdn.jsdelivr.net/npm/vuetify@3.7.4/dist/vuetify.min.js'"></script>
    <script src="{{ url_for('static', filename='libs/plotly.min.js') }}" onerror="this.onerror=null; this.src='https://cdn.jsdelivr.net/npm/plotly.js@2.35.2/dist/plotly.min.js'"></script>
    <script src="{{ url_for('static', filename='libs/socket.io.min.js') }}" onerror="this.onerror=null; this.src='https://cdn.socket.io/4.5.4/socket.io.min.js'"></script>
    
    <style>
        .monomaniac-one-regular {
            font-family: "Monomaniac One", sans-serif;
            font-weight: 400;
            font-style: normal;
        }

        .noto-sans-jp-normal {
            font-family: "Noto Sans JP", serif;
            font-optical-sizing: auto;
            font-weight: 600;
            font-style: normal;
        }

        body {
            font-family: "Noto Sans JP", serif;
            font-optical-sizing: auto;
            font-weight: 600;
            font-style: normal;
        }

        .main-view {
            font-family: "Monomaniac One", sans-serif;
            font-weight: 400;
            font-style: normal;
            font-size: 80px;
            text-align: right;
            line-height: 1;
            padding: 20px;
        }

        .main-view .set {
            font-size: 50%;
        }

        .main-view .unit {
            font-size: 50%;
        }

        .voltage {
            color: oklch(63.11% 0.1964 139.76)
        }

        .current {
            color: oklch(63.11% 0.1964 26.48)
        }

        .voltage.v-chip {
            background: oklch(63.11% 0.1964 139.76);
            color: white;
        }

        .current.v-chip {
            background: oklch(63.11% 0.1964 26.48);
            color: white;
        }

        .v-chip {
            margin-left: 5px;
        }

        .power {
            color: #666;
        }

        #graph {
            width: 100%;
            height: 400px;
        }
    </style>
</head>
<body>
    <div id="app">
        <v-app>
            <v-main>
                <v-container fluid>
                    <!-- Verbindungs-Overlay -->
                    <v-overlay :model-value="!connected" class="align-center justify-center">
                        <v-card min-width="400">
                            <v-card-title>FNIRSI DPS-150 verbinden</v-card-title>
                            <v-card-text>
                                <v-row>
                                    <v-col cols="10">
                                        <v-select
                                            v-model="selectedPort"
                                            :items="availablePorts"
                                            item-title="title"
                                            item-value="device"
                                            label="Serieller Port"
                                            density="comfortable"
                                        ></v-select>
                                    </v-col>
                                    <v-col cols="2">
                                        <v-btn icon="mdi-refresh" @click="refreshPorts" variant="text"></v-btn>
                                    </v-col>
                                </v-row>
                            </v-card-text>
                            <v-card-actions>
                                <v-spacer></v-spacer>
                                <v-btn color="primary" @click="connect" :disabled="!selectedPort">
                                    Verbinden
                                </v-btn>
                            </v-card-actions>
                        </v-card>
                    </v-overlay>

                    <!-- Hauptansicht -->
                    <v-row v-if="connected">
                        <v-col cols="12">
                            <v-card>
                                <v-card-title>
                                    <span v-text="device.modelName || 'DPS-150'"></span>
                                    <v-chip class="ml-2" size="small">
                                        HW: <span v-text="device.hardwareVersion"></span>
                                    </v-chip>
                                    <v-chip class="ml-2" size="small">
                                        FW: <span v-text="device.firmwareVersion"></span>
                                    </v-chip>
                                    <v-spacer></v-spacer>
                                    <v-btn icon @click="disconnect">
                                        <v-icon>mdi-close</v-icon>
                                    </v-btn>
                                </v-card-title>
                            </v-card>
                        </v-col>

                        <!-- Ausgabewerte -->
                        <v-col cols="12" md="6">
                            <v-card>
                                <v-card-text>
                                    <div class="main-view">
                                        <div class="voltage">
                                            <span v-text="device.outputVoltage.toFixed(3)"></span>
                                            <span class="unit">V</span>
                                            <div class="set">
                                                Set: <span v-text="device.setVoltage.toFixed(2)"></span> V
                                            </div>
                                        </div>
                                        <div class="current">
                                            <span v-text="device.outputCurrent.toFixed(3)"></span>
                                            <span class="unit">A</span>
                                            <div class="set">
                                                Set: <span v-text="device.setCurrent.toFixed(2)"></span> A
                                            </div>
                                        </div>
                                        <div class="power">
                                            <span v-text="device.outputPower.toFixed(3)"></span>
                                            <span class="unit">W</span>
                                        </div>
                                    </div>
                                </v-card-text>
                            </v-card>
                        </v-col>

                        <!-- Steuerung -->
                        <v-col cols="12" md="6">
                            <v-card>
                                <v-card-text>
                                    <v-row>
                                        <v-col cols="12">
                                            <v-text-field
                                                v-model.number="voltageInput"
                                                label="Spannung (V)"
                                                type="number"
                                                step="0.1"
                                                @keyup.enter="setVoltage"
                                            >
                                                <template v-slot:append>
                                                    <v-btn @click="setVoltage" size="small">Set</v-btn>
                                                </template>
                                            </v-text-field>
                                        </v-col>
                                        <v-col cols="12">
                                            <v-text-field
                                                v-model.number="currentInput"
                                                label="Strom (A)"
                                                type="number"
                                                step="0.1"
                                                @keyup.enter="setCurrent"
                                            >
                                                <template v-slot:append>
                                                    <v-btn @click="setCurrent" size="small">Set</v-btn>
                                                </template>
                                            </v-text-field>
                                        </v-col>
                                        <v-col cols="12">
                                            <v-btn
                                                block
                                                :color="device.outputClosed ? 'error' : 'success'"
                                                @click="toggleOutput"
                                            >
                                                <v-icon left v-text="device.outputClosed ? 'mdi-power-off' : 'mdi-power'"></v-icon>
                                                <span v-text="device.outputClosed ? 'Ausgabe AUS' : 'Ausgabe EIN'"></span>
                                            </v-btn>
                                        </v-col>
                                    </v-row>
                                </v-card-text>
                            </v-card>

                            <!-- Status -->
                            <v-card class="mt-4">
                                <v-card-text>
                                    <v-row dense>
                                        <v-col cols="6">Eingangsspannung:</v-col>
                                        <v-col cols="6" class="text-right"><span v-text="device.inputVoltage.toFixed(2)"></span> V</v-col>
                                        
                                        <v-col cols="6">Temperatur:</v-col>
                                        <v-col cols="6" class="text-right"><span v-text="device.temperature.toFixed(1)"></span> °C</v-col>
                                        
                                        <v-col cols="6">Modus:</v-col>
                                        <v-col cols="6" class="text-right">
                                            <v-chip size="small" :color="device.mode === 'CV' ? 'voltage' : 'current'">
                                                <span v-text="device.mode"></span>
                                            </v-chip>
                                        </v-col>
                                        
                                        <v-col cols="6">Kapazität:</v-col>
                                        <v-col cols="6" class="text-right"><span v-text="device.outputCapacity.toFixed(3)"></span> Ah</v-col>
                                        
                                        <v-col cols="6">Energie:</v-col>
                                        <v-col cols="6" class="text-right"><span v-text="device.outputEnergy.toFixed(3)"></span> Wh</v-col>
                                        
                                        <v-col cols="12" v-if="device.protectionState">
                                            <v-alert type="error" dense>
                                                Schutz aktiv: <span v-text="device.protectionState"></span>
                                            </v-alert>
                                        </v-col>
                                    </v-row>
                                </v-card-text>
                            </v-card>
                        </v-col>

                        <!-- Graph -->
                        <v-col cols="12">
                            <v-card>
                                <v-card-title>Verlauf</v-card-title>
                                <v-card-text>
                                    <div id="graph"></div>
                                </v-card-text>
                            </v-card>
                        </v-col>
                    </v-row>
                </v-container>
            </v-main>
        </v-app>
    </div>

    <script>
        const { createApp } = Vue;
        const { createVuetify } = Vuetify;

        const vuetify = createVuetify();

        createApp({
            data() {
                return {
                    socket: null,
                    connected: false,
                    availablePorts: [],
                    selectedPort: null,
                    voltageInput: 0,
                    currentInput: 0,
                    device: {
                        inputVoltage: 0,
                        setVoltage: 0,
                        setCurrent: 0,
                        outputVoltage: 0,
                        outputCurrent: 0,
                        outputPower: 0,
                        temperature: 0,
                        outputClosed: false,
                        protectionState: "",
                        mode: "CV",
                        outputCapacity: 0,
                        outputEnergy: 0,
                        modelName: "",
                        firmwareVersion: "",
                        hardwareVersion: "",
                    },
                    history: {
                        time: [],
                        voltage: [],
                        current: [],
                        power: []
                    }
                };
            },

            mounted() {
                this.initSocket();
                this.refreshPorts();
            },

            methods: {
                initSocket() {
                    this.socket = io();
                    
                    this.socket.on('connect', () => {
                        console.log('WebSocket verbunden');
                    });

                    this.socket.on('device_data', (data) => {
                        // Update device data
                        Object.assign(this.device, data);
                        
                        // Update history
                        this.history.time.push(new Date());
                        this.history.voltage.push(data.outputVoltage || 0);
                        this.history.current.push(data.outputCurrent || 0);
                        this.history.power.push(data.outputPower || 0);
                        
                        // Keep only last 500 points
                        if (this.history.time.length > 500) {
                            this.history.time.shift();
                            this.history.voltage.shift();
                            this.history.current.shift();
                            this.history.power.shift();
                        }
                        
                        this.updateGraph();
                    });

                    this.socket.on('disconnect', () => {
                        console.log('WebSocket getrennt');
                    });
                },

                async refreshPorts() {
                    try {
                        const response = await fetch('/api/ports');
                        const ports = await response.json();
                        console.log('Empfangene Ports:', ports);
                        this.availablePorts = ports;
                        console.log('Verfügbare Ports gesetzt:', this.availablePorts);
                        
                        // Automatisch den AT32-Port auswählen, falls vorhanden
                        const at32Port = ports.find(p => p.selected);
                        if (at32Port) {
                            this.selectedPort = at32Port.device;
                            console.log('AT32-Port automatisch ausgewählt:', this.selectedPort);
                        }
                    } catch (error) {
                        console.error('Fehler beim Laden der Ports:', error);
                    }
                },

                async connect() {
                    try {
                        const response = await fetch('/api/connect', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ port: this.selectedPort })
                        });
                        
                        if (response.ok) {
                            this.connected = true;
                        } else {
                            const error = await response.json();
                            alert('Verbindungsfehler: ' + error.error);
                        }
                    } catch (error) {
                        console.error('Fehler beim Verbinden:', error);
                        alert('Verbindungsfehler: ' + error.message);
                    }
                },

                async disconnect() {
                    try {
                        await fetch('/api/disconnect', { method: 'POST' });
                        this.connected = false;
                    } catch (error) {
                        console.error('Fehler beim Trennen:', error);
                    }
                },

                async setVoltage() {
                    try {
                        await fetch('/api/set/voltage', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ value: this.voltageInput })
                        });
                    } catch (error) {
                        console.error('Fehler beim Setzen der Spannung:', error);
                    }
                },

                async setCurrent() {
                    try {
                        await fetch('/api/set/current', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ value: this.currentInput })
                        });
                    } catch (error) {
                        console.error('Fehler beim Setzen des Stroms:', error);
                    }
                },

                async toggleOutput() {
                    try {
                        const endpoint = this.device.outputClosed ? '/api/output/disable' : '/api/output/enable';
                        await fetch(endpoint, { method: 'POST' });
                    } catch (error) {
                        console.error('Fehler beim Umschalten der Ausgabe:', error);
                    }
                },

                updateGraph() {
                    // Prüfe ob Graph-Element existiert (nur wenn verbunden)
                    const graphElement = document.getElementById('graph');
                    if (!graphElement) {
                        return;
                    }

                    const data = [
                        {
                            x: this.history.time,
                            y: this.history.voltage,
                            name: 'Spannung (V)',
                            type: 'scatter',
                            mode: 'lines',
                            line: { color: 'oklch(63.11% 0.1964 139.76)' }
                        },
                        {
                            x: this.history.time,
                            y: this.history.current,
                            name: 'Strom (A)',
                            type: 'scatter',
                            mode: 'lines',
                            yaxis: 'y2',
                            line: { color: 'oklch(63.11% 0.1964 26.48)' }
                        },
                        {
                            x: this.history.time,
                            y: this.history.power,
                            name: 'Leistung (W)',
                            type: 'scatter',
                            mode: 'lines',
                            yaxis: 'y3',
                            line: { color: '#666' }
                        }
                    ];

                    const layout = {
                        xaxis: { title: 'Zeit' },
                        yaxis: { title: 'Spannung (V)', titlefont: { color: 'oklch(63.11% 0.1964 139.76)' } },
                        yaxis2: {
                            title: 'Strom (A)',
                            titlefont: { color: 'oklch(63.11% 0.1964 26.48)' },
                            overlaying: 'y',
                            side: 'right'
                        },
                        yaxis3: {
                            title: 'Leistung (W)',
                            titlefont: { color: '#666' },
                            overlaying: 'y',
                            side: 'right',
                            position: 0.95
                        },
                        showlegend: true,
                        margin: { r: 150 }
                    };

                    Plotly.newPlot('graph', data, layout);
                }
            }
        }).use(vuetify).mount('#app');
    </script>
</body>
</html>
